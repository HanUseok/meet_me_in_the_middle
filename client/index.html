<!doctype html>
<html lang="ko">
<head>
  <!-- ë¬¸ì„œ ì¸ì½”ë”©/ë·°í¬íŠ¸/íƒ€ì´í‹€ -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>meet_me_in_the_middle Â· MVP</title>

  <!--
    ê¸°ë³¸ ìŠ¤íƒ€ì¼:
    - :root --peek : í•˜ë‹¨ ì‹œíŠ¸ê°€ ì ‘í˜”ì„ ë•Œ ë³´ì´ëŠ” ë†’ì´
    - #map : ì „ í™”ë©´ ì§€ë„
    - .sheet : í•˜ë‹¨ ë“œë˜ê·¸ ì‹œíŠ¸(ê²€ìƒ‰/ê²°ê³¼ íŒ¨ë„)
    - íŒì—…(.top3-popup/.popup-content/...) : ì¶”ì²œ Top3 ëª¨ë‹¬
  -->
  <style>
    :root{color-scheme:light dark;--peek:92px}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#f5f7fb;overflow-x:hidden}
    *, *::before, *::after{box-sizing:border-box}
    #map{position:fixed;inset:0;width:100%;height:100%;z-index:0}

    /* í•˜ë‹¨ ì‹œíŠ¸(ì—´ë¦¼/ì ‘í˜ì€ --sheet-offset ìœ¼ë¡œ ì œì–´) */
    .sheet{--sheet-offset:0px;position:fixed;left:0;right:0;bottom:0;z-index:10;background:#fff;border-top:1px solid #eee;border-radius:20px 20px 0 0;box-shadow:0 -16px 40px rgba(0,0,0,.12);display:flex;flex-direction:column;align-items:center;max-height:78vh;transition:transform .35s ease;will-change:transform;transform:translateY(var(--sheet-offset));overscroll-behavior:contain;min-height:200px;width:100%;overflow-x:hidden}
    .sheet > *{width:100%}
    .sheet.collapsed{--sheet-offset:calc(100% - var(--peek))}
    .sheet.open{--sheet-offset:0px}
    .sheet.dragging{transition:none}
    /* ì ‘í˜ ìƒíƒœì—ì„œëŠ” í—¤ë”ë§Œ ë³´ì´ë„ë¡ ë³¸ë¬¸ì„ ìˆ¨ê²¨ í”¼í¬ ë†’ì´ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€ */
    .sheet.collapsed .sheet-body{display:none}
    .sheet-header{padding:18px 24px 14px;display:flex;flex-direction:column;gap:14px;cursor:grab;-webkit-user-select:none;user-select:none;touch-action:none;max-width:860px;margin:0 auto;width:100%}
    .sheet-header:focus-visible{outline:2px solid #4c5468;outline-offset:4px}
    .sheet-header:active{cursor:grabbing}
    .sheet-handle{width:48px;height:4px;border-radius:999px;background:#d0d4dc;margin:0 auto}
    .sheet-header-bar{display:flex;align-items:center;justify-content:center;gap:12px}
    .sheet-title{font-size:15px;font-weight:600;color:#1a1e27}
    .sheet-body{padding:8px 24px 24px;overflow-y:auto;max-width:860px;margin:0 auto}

    /* ì…ë ¥/ë²„íŠ¼ ê³µí†µ */
    .row{display:flex;gap:12px;align-items:center;justify-content:center;margin:12px 0;flex-wrap:wrap}
    .row > input{flex:1;min-width:200px;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row > button{white-space:nowrap}
    input,select,button{padding:13px;border-radius:12px;border:1px solid #d8dce6;font-size:15px;background:#fff;color:#1a1e27}
    button{cursor:pointer}
    .btn-primary{background:#111;color:#fff;border-color:#111}
    .btn-location{background:#4c5468;color:#fff;border:0;padding:10px 12px;font-size:14px}
    .btn-location:hover{background:#2f3443}
    .tab{padding:8px 12px;border:1px solid #d8dce6;border-radius:999px;background:#fff;color:#1a1e27;font-weight:600}
    .tab.on{background:#111;color:#fff;border-color:#111}

    /* ì¹´ë“œ/ìƒíƒœ/ë±ƒì§€ */
    .card{border:1px solid #e6e9f1;border-radius:16px;padding:16px;margin:12px 0;background:#fff;color:#1a1e27;box-shadow:0 4px 12px rgba(17,23,34,.06)}
    .card-hint{background:#f6f8ff;border-color:#d6dcff;color:#1a1e27}
    .card-center{background:#f6f8ff;border-color:#d6dcff}
    .badge{display:inline-flex;align-items:center;gap:4px;background:#f0f1f6;border-radius:999px;padding:4px 10px;margin-right:6px;font-size:12px;font-weight:600;color:#50586b}
    .status{font-size:12px;color:#555;margin:8px 0 4px;min-height:20px}
    .btn-inline{margin-top:10px;padding:10px 14px;border-radius:12px;border:1px solid #c5c9d8;background:#fff;color:#1a1e27;font-size:13px;font-weight:600}
    .btn-inline:hover{background:#f0f2f8}

    /* ì¶”ì²œ Top3 íŒì—…(ë°”í…€ì‹œíŠ¸ í˜•íƒœ) */
    .top3-popup{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;background:rgba(17,23,34,.35);transition:opacity .25s ease;opacity:1}
    .top3-popup.hidden{opacity:0;pointer-events:none}
    .popup-content{background:#fff;border-radius:20px;box-shadow:0 8px 32px rgba(17,23,34,.15);padding:26px 24px 22px;max-width:500px;width:100%;position:relative;color:#111;display:flex;flex-direction:column;gap:18px;max-height:70vh;overflow-y:auto}
    .popup-title{font-size:18px;font-weight:700;margin:0;color:#111}
    .popup-close{position:absolute;top:14px;right:14px;width:32px;height:32px;border-radius:50%;border:0;background:#f0f2f8;color:#111;font-size:20px;line-height:0;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .popup-close:hover{background:#e0e3ed}
    .popup-list{display:flex;flex-direction:column;gap:12px;max-height:60vh;overflow-y:auto;padding-right:4px}
    .popup-card{border:1px solid #e1e5f2;border-radius:18px;padding:16px;background:#fff;display:flex;flex-direction:column;gap:10px;box-shadow:0 10px 32px rgba(17,23,34,.12)}
    .popup-card-header{display:flex;align-items:center;gap:10px}
    .popup-rank{font-size:15px;font-weight:700;color:#69728a}
    .popup-name{font-size:17px;font-weight:700;color:#111}
    .popup-meta{font-size:13px;color:#586076;display:flex;flex-wrap:wrap;gap:6px}
    .popup-action{align-self:flex-start;padding:10px 16px;border-radius:12px;border:0;background:#111;color:#fff;font-size:14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .popup-action:hover{background:#2f3443}
    .popup-icon{font-size:20px}
    .popup-tabs{display:flex;gap:8px;padding:16px 24px 0;border-bottom:1px solid #e6e9f1}
    .popup-tab{padding:8px 12px;border:1px solid #d8dce6;border-radius:999px;background:#fff;color:#1a1e27;font-weight:600;cursor:pointer}
    .popup-tab.on{background:#111;color:#fff;border-color:#111}
    .fab{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--peek) + 24px);z-index:15;background:#111;color:#fff;padding:14px 20px;border-radius:999px;font-weight:600;font-size:15px;border:0;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25);transition:transform .2s ease,background .2s ease}
    .fab:hover{background:#2f3443;transform:translateX(-50%) translateY(-2px)}
    .fab:active{transform:translateX(-50%) translateY(0)}
    .legend{position:fixed;right:16px;bottom:120px;z-index:14;background:#fff;border:1px solid #e1e5f2;border-radius:16px;padding:14px 16px;box-shadow:0 8px 24px rgba(0,0,0,.1);font-size:13px;line-height:1.8}
    .legend-item{display:flex;align-items:center;color:#333}

    /* ëª¨ë°”ì¼ì—ì„œ ì—¬ë°±/ê¸€ì í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
    @media (max-width:768px){
      .popup-content{padding:22px 20px 18px;border-radius:22px}
      .popup-card{padding:14px}
      .popup-name{font-size:16px}
      .sheet-body{max-width:100%}
      .row{justify-content:stretch}
      .sheet-header{max-width:100%}
    }
    
    /* ì´ˆì†Œí˜• í™”ë©´ì—ì„œ ì…ë ¥ì´ í™”ë©´ì„ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ê°•ì œ ì¤„ë°”ê¿ˆ */
    @media (max-width:420px){
      .row{gap:8px}
      .row > input{min-width:0;width:100%}
      .row > button{width:100%}
    }
    
    /* í° í™”ë©´ì—ì„œ ì…ë ¥ ì˜ì—­ ìµœëŒ€ í­ ì œí•œ ë° ì¤‘ì•™ ì •ë ¬ */
    @media (min-width:1024px){
      .sheet-body{max-width:980px}
    }
  </style>

  <!--
    Kakao Maps JS SDKëŠ” ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ (app.jsì—ì„œ)
  -->
</head>
<body>
  <!-- ì „ í™”ë©´ ì§€ë„ ìº”ë²„ìŠ¤ -->
  <div id="map"></div>
  
  <!-- ì§€ë„ ë ˆì „ë“œ -->
  <div id="legend" class="legend" style="display:none">
    <div class="legend-item"><span style="background:#39678F;width:16px;height:16px;border-radius:50%;display:inline-block;margin-right:6px"></span>ì¤‘ê°„ì§€ì </div>
    <div class="legend-item"><span style="background:#4caf50;width:16px;height:16px;border-radius:50%;display:inline-block;margin-right:6px"></span>ì°¸ì—¬ì</div>
    <div class="legend-item"><span style="background:#111;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#fff;margin-right:6px">1</span>Top 1</div>
    <div class="legend-item"><span style="background:#111;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#fff;margin-right:6px">2</span>Top 2</div>
    <div class="legend-item"><span style="background:#111;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#fff;margin-right:6px">3</span>Top 3</div>
  </div>

  <!-- ì¶”ì²œ Top3 ëª¨ë‹¬(ì¬ì‚¬ìš©ë˜ëŠ” ì»¨í…Œì´ë„ˆ) -->
  <div id="top3-popup" class="top3-popup hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="popup-content">
      <button type="button" class="popup-close" aria-label="ë‹«ê¸°">Ã—</button>
      <h2 class="popup-title">ì¶”ì²œ Top3</h2>
      <div class="popup-tabs" id="popup-tabs" style="display:none"></div>
      <div class="popup-tabs" id="route-mode-tabs" style="display:none"></div>
      <div class="popup-list"></div>
      
      <!-- ì½”ìŠ¤ ì¥ë°”êµ¬ë‹ˆ íŒ¨ë„ -->
      <div id="course-cart-panel" style="display:none;border-top:1px solid #e6e9f1;padding-top:16px;margin-top:16px">
        <div class="cart-title" style="font-weight:700;font-size:16px;margin-bottom:12px">ë‚´ ì½”ìŠ¤ ğŸ§­ (0)</div>
        <div class="cart-pills" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px"></div>
        <button type="button" class="recommend-course-btn popup-action" style="width:100%;margin-top:8px" disabled>ì¶”ì²œ ì½”ìŠ¤ ë³´ê¸°</button>
      </div>
      
      <!-- ì½”ìŠ¤ ê²°ê³¼ ì„¹ì…˜ -->
      <div id="course-results-section" style="display:none;border-top:1px solid #e6e9f1;padding-top:16px;margin-top:16px">
        <div class="course-results-header" style="font-weight:700;font-size:16px;margin-bottom:12px">ğŸ’¡ ì¶”ì²œ ì½”ìŠ¤ 3ê°œê°€ ë§Œë“¤ì–´ì¡Œì–´ìš”</div>
        <div class="course-results-list" style="display:flex;flex-direction:column;gap:12px"></div>
      </div>
    </div>
  </div>
  

  <!-- í•˜ë‹¨ ì‹œíŠ¸: ê²€ìƒ‰ ì…ë ¥/ê²°ê³¼/ìƒíƒœ/í† ìŠ¤íŠ¸ -->
  <div class="sheet collapsed" id="sheet" aria-expanded="false">
    <div class="sheet-header" id="sheetHeader" role="button" tabindex="0" aria-controls="sheetBody" aria-expanded="false">
      <div class="sheet-handle" aria-hidden="true"></div>
      <div class="sheet-header-bar">
        <span class="sheet-title">ê²€ìƒ‰ Â· ê²°ê³¼</span>
      </div>
    </div>
    <div class="sheet-body" id="sheetBody">
      <!-- ì°¸ì—¬ì ì…ë ¥(ì°¸ì—¬ì1ì€ 'ë‚´ ìœ„ì¹˜'ë¡œ ìë™ ì±„ì›€ ê°€ëŠ¥) -->
      <div class="row"><input id="p1" placeholder="ë³¸ì¸ ìœ„ì¹˜" /><button class="btn-location" type="button">ë‚´ ìœ„ì¹˜</button></div>
      <div class="row"><input id="p2" placeholder="ì°¸ì—¬ì2 ì¥ì†Œ (ì˜ˆ: í™ëŒ€ì…êµ¬ì—­)" /></div>

      <!-- ì•¡ì…˜: ì¤‘ê°„ì§€ì  ì‚°ì¶œ â†’ ì¸ê¸° ì§€ì—­ Top3 íƒìƒ‰ -->
      <div class="row">
        <button id="btnCenter" class="btn-primary" type="button">ì¤‘ê°„ì§€ì â†’ì§€ì—­ Top3</button>
      </div>

      <!-- ìƒíƒœ ë©”ì‹œì§€ / ê²°ê³¼ ì¹´ë“œ / í† ìŠ¤íŠ¸ -->
      <div class="status" id="status">ì¤€ë¹„ë¨</div>
      <div id="results"></div>
      <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:90px;z-index:30;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none"></div>
    </div>
  </div>

  <!--
    ëª¨ë“ˆ ì—”íŠ¸ë¦¬:
    - ì„œë²„ì—ì„œ ì¹´ì¹´ì˜¤ API í‚¤ë¥¼ ê°€ì ¸ì™€ ë™ì ìœ¼ë¡œ SDK ë¡œë“œ
    - session-ui/app.js ì˜ initApp()ì„ Kakao SDK ì¤€ë¹„ í›„ í˜¸ì¶œ
  -->
  <script type="module">
    import { initApp } from './session-ui/app.js';
    
    // ì„œë²„ì—ì„œ ì¹´ì¹´ì˜¤ API í‚¤ ê°€ì ¸ì˜¤ê¸°
    async function loadKakaoSDK() {
      try {
        const response = await fetch('http://localhost:3000/api/config');
        if (!response.ok) {
          throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        const config = await response.json();
        const kakaoAppKey = config.kakaoAppKey;
        
        if (!kakaoAppKey) {
          console.error('âŒ ì¹´ì¹´ì˜¤ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì— KAKAO_APP_KEYë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
          return;
        }
        
        console.log('âœ… ì¹´ì¹´ì˜¤ API í‚¤ ë¡œë“œ ì™„ë£Œ');
        
        // ë™ì ìœ¼ë¡œ ì¹´ì¹´ì˜¤ SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
        const script = document.createElement('script');
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoAppKey}&libraries=services,drawing&autoload=false`;
        script.async = true;
        
        script.onload = () => {
          console.log('âœ… Kakao Maps SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
          
          // kakao ê°ì²´ê°€ ì „ì—­ì— ì„¤ì •ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 2ì´ˆ)
          let retryCount = 0;
          const maxRetries = 20;
          const checkKakao = setInterval(() => {
            if (typeof window.kakao !== 'undefined' && window.kakao.maps && typeof window.kakao.maps.load === 'function') {
              clearInterval(checkKakao);
              console.log('âœ… Kakao ê°ì²´ í™•ì¸ ì™„ë£Œ');
              window.kakao.maps.load(() => {
                console.log('âœ… Kakao Maps ì´ˆê¸°í™” ì™„ë£Œ');
                initApp();
              });
            } else {
              retryCount++;
              if (retryCount >= maxRetries) {
                clearInterval(checkKakao);
                console.error('âŒ Kakao Maps SDK ì´ˆê¸°í™” ì‹¤íŒ¨: kakao ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              }
            }
          }, 100);
        };
        
        script.onerror = (error) => {
          console.error('âŒ Kakao Maps SDK ë¡œë“œ ì‹¤íŒ¨:', error);
        };
        
        document.head.appendChild(script);
      } catch (error) {
        console.error('âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        console.error('ğŸ’¡ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: http://localhost:3000');
        console.error('ğŸ’¡ CORS ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ì¹´ì˜¤ SDK ë¡œë“œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadKakaoSDK);
    } else {
      loadKakaoSDK();
    }
  </script>
</body>
</html>
